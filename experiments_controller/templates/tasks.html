<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <!-- 引入 Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .log-container {
            max-height: 200px;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
    </style>
    <!-- 引入 jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        async function toggleDetails(taskID) {
            const detailsDiv = document.getElementById(`details-${taskID}`);
            const toggleButton = document.getElementById(`toggle-btn-${taskID}`);

            if (detailsDiv.classList.contains("hidden")) {
                toggleButton.textContent = "Hide Details";
                detailsDiv.classList.remove("hidden");
                await fetchTaskDetails(taskID);
                await fetchTaskLogs(taskID);
            } else {
                toggleButton.textContent = "Show Details";
                detailsDiv.classList.add("hidden");
            }
        }

        async function fetchTaskDetails(taskID) {
            const response = await fetch(`/task/${taskID}/details`);
            const detailsDiv = document.getElementById(`details-${taskID}-content`);
            if (!detailsDiv) return;

            if (response.ok) {
                const data = await response.json();
                detailsDiv.innerHTML = `
                    <p><strong>Task Type:</strong> ${data.type}</p>
                    <p><strong>Payload:</strong> <pre>${JSON.stringify(JSON.parse(data.payload), null, 2)}</pre></p>
                    <p><strong>Status:</strong> ${data.status}</p>
                    <p><strong>Created At:</strong> ${data.created_at}</p>
                `;
            } else {
                detailsDiv.innerHTML = `<p class="text-red-500">Error: Unable to fetch details.</p>`;
            }
        }

        async function fetchTaskLogs(taskID) {
            const response = await fetch(`/task/${taskID}/logs`);
            const logsDiv = document.getElementById(`logs-${taskID}`);
            if (!logsDiv) return;

            if (response.ok) {
                const data = await response.json();
                const parsedLogs = data.logs.map(log => {
                    const splitIndex = log.indexOf(" - ");
                    const time = splitIndex !== -1 ? log.slice(0, splitIndex) : "Unknown";
                    const message = splitIndex !== -1 ? log.slice(splitIndex + 3) : log;
                    return { time, message };
                });
                logsDiv.innerHTML = `
                    <h3 class="font-bold mb-2">Logs:</h3>
                    <ul class="list-disc ml-5">
                        ${parsedLogs
                            .map(log => `<li><strong>${log.time}</strong>: ${log.message}</li>`)
                            .join("")}
                    </ul>
                `;
            } else {
                logsDiv.innerHTML = `<p class="text-red-500">Error: Unable to fetch logs.</p>`;
            }
        }

        function addKeyValuePair() {
            const container = document.getElementById("keyValuePairs");
            const row = document.createElement("div");
            row.className = "flex space-x-4 mb-2";

            row.innerHTML = `
                <input type="text" placeholder="Key" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline key-input">
                <input type="text" placeholder="Value" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline value-input">
                <button type="button" class="text-red-500 font-bold" onclick="this.parentElement.remove()">Remove</button>
            `;

            container.appendChild(row);
        }

        let injectionData = {};

        async function fetchInjectionData() {
            try {
                const response = await fetch('/injection');
                if (response.ok) {
                    injectionData = await response.json();
                    populateFaultTypeSelect();
                } else {
                    console.error('Failed to fetch injection data');
                }
            } catch (error) {
                console.error('Error fetching injection data:', error);
            }
        }

        function populateFaultTypeSelect() {
            const faultTypeSelect = document.getElementById('faultTypeSelect');
            faultTypeSelect.innerHTML = '';
            const keymap = injectionData.keymap || {};
            for (const [key, value] of Object.entries(keymap)) {
                const option = document.createElement('option');
                option.value = key; // 使用故障类型的数字表示
                option.textContent = value;
                faultTypeSelect.appendChild(option);
            }
            // 设置默认值并加载参数
            if (faultTypeSelect.options.length > 0) {
                faultTypeSelect.selectedIndex = 0;
                const selectedFaultTypeKey = faultTypeSelect.options[0].value;
                populateFaultParameters(selectedFaultTypeKey);
            }
        }

        function populateFaultParameters(faultTypeKey) {
            const faultParametersDiv = document.getElementById('faultParameters');
            faultParametersDiv.innerHTML = ''; // 清除之前的参数
            const faultTypeName = injectionData.keymap[faultTypeKey];
            const specification = injectionData.specification[faultTypeName];
            if (specification) {
                specification.forEach(param => {
                    const paramDiv = document.createElement('div');
                    paramDiv.className = 'mb-2';
                    paramDiv.innerHTML = `
                        <label class="block text-gray-700 text-sm font-bold mb-1">${param.FieldName} (${param.Min} - ${param.Max}) ${param.IsOptional ? '(Optional)' : ''}</label>
                        <input type="number" id="param-${param.FieldName}" name="${param.FieldName}" min="${param.Min}" max="${param.Max}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    `;
                    faultParametersDiv.appendChild(paramDiv);
                });
            } else {
                faultParametersDiv.innerHTML = '<p class="text-red-500">No parameters found for this fault type.</p>';
            }
        }

        async function submitTask(event) {
            event.preventDefault(); // 阻止表单默认提交

            const taskType = document.getElementById("taskType").value;

            let payload = {};

            if (taskType === "RunAlgorithm") {
                // 获取选中的算法
                const selectedAlgorithm = document.getElementById('algorithmSelect').value;
                const benchmark = document.getElementById("benchmarkSelect").value;
                const dataset = document.getElementById("datasetSelect").value;

                if (!selectedAlgorithm) {
                    alert("Please select an algorithm.");
                    return;
                }

                // 构建 payload
                payload = {
                    algorithm: selectedAlgorithm,
                    benchmark: benchmark,
                    dataset: dataset
                };

            } else if (taskType === "FaultInjection") {
                // 收集故障类型和参数
                const faultTypeKey = document.getElementById('faultTypeSelect').value;
                const faultTypeName = injectionData.keymap[faultTypeKey];
                const specification = injectionData.specification[faultTypeName];

                if (!faultTypeName || !specification) {
                    alert("Invalid fault type selected.");
                    return;
                }

                payload['faultType'] = faultTypeKey; // 使用数字表示的故障类型

                // 收集参数
                let parametersValid = true;
                const parameters = {};

                specification.forEach(param => {
                    const input = document.getElementById(`param-${param.FieldName}`);
                    let value = input.value.trim();

                    if (value === '' && !param.IsOptional) {
                        alert(`${param.FieldName} is required.`);
                        parametersValid = false;
                        return;
                    }

                    value = Number(value);
                    if (isNaN(value) || value < param.Min || value > param.Max) {
                        alert(`${param.FieldName} must be a number between ${param.Min} and ${param.Max}.`);
                        parametersValid = false;
                        return;
                    }

                    parameters[param.FieldName] = value;
                });

                if (!parametersValid) {
                    return;
                }

                // 合并参数到 payload
                payload["spec"] = parameters;

            } else {
                // 从键值对构建 JSON
                const keyInputs = document.querySelectorAll(".key-input");
                const valueInputs = document.querySelectorAll(".value-input");
                payload = {};

                keyInputs.forEach((keyInput, index) => {
                    const key = keyInput.value.trim();
                    const value = valueInputs[index].value.trim();
                    if (key) {
                        payload[key] = value;
                    }
                });

                if (Object.keys(payload).length === 0) {
                    alert("Payload cannot be empty");
                    return;
                }
            }

            const url = `/submit?type=${encodeURIComponent(taskType)}`;
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });

            const data = await response.json();
            if (response.ok) {
                alert(`Task submitted successfully: ${data.taskID}`);
                location.reload();
            } else {
                alert(`Error: ${data.error}`);
            }
        }

        async function fetchAlgoBench() {
            try {
                const [algobenchResponse, datasetsResponse] = await Promise.all([
                    fetch('/algobench'),
                    fetch('/datasets')
                ]);

                if (algobenchResponse.ok) {
                    const algobenchData = await algobenchResponse.json();
                    const algorithms = algobenchData.algorithms || [];
                    const benchmarks = algobenchData.benchmarks || [];
                    populateAlgorithmSelect(algorithms);
                    populateBenchmarkSelect(benchmarks);
                } else {
                    console.error('Failed to fetch algorithms and benchmarks');
                }

                if (datasetsResponse.ok) {
                    const datasetsData = await datasetsResponse.json();
                    const datasets = datasetsData.datasets || [];
                    populateDatasetSelect(datasets);
                } else {
                    console.error('Failed to fetch datasets');
                }

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // 填充算法选择框
        function populateAlgorithmSelect(algorithms) {
            const algorithmSelect = document.getElementById('algorithmSelect');
            algorithmSelect.innerHTML = '';
            algorithms.forEach(algorithm => {
                const option = document.createElement('option');
                option.value = algorithm;
                option.textContent = algorithm;
                algorithmSelect.appendChild(option);
            });
        }

        function populateBenchmarkSelect(benchmarks) {
            const benchmarkSelect = document.getElementById('benchmarkSelect');
            benchmarkSelect.innerHTML = '';
            benchmarks.forEach(benchmark => {
                const option = document.createElement('option');
                option.value = benchmark;
                option.textContent = benchmark;
                benchmarkSelect.appendChild(option);
            });
        }

        function populateDatasetSelect(datasets) {
            const datasetSelect = document.getElementById('datasetSelect');
            datasetSelect.innerHTML = '';
            datasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset;
                option.textContent = dataset;
                datasetSelect.appendChild(option);
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            fetchAlgoBench();
            fetchInjectionData().then(() => {
                const taskTypeSelect = document.getElementById('taskType');

                taskTypeSelect.addEventListener('change', function() {
                    const taskType = this.value;
                    if (taskType === 'RunAlgorithm') {
                        // 显示算法、基准和数据集选择
                        document.getElementById('algorithmSelection').classList.remove('hidden');
                        document.getElementById('benchmarkSelection').classList.remove('hidden');
                        document.getElementById('datasetSelection').classList.remove('hidden');
                        // 隐藏键值对输入和故障注入选项
                        document.getElementById('keyValuePairsContainer').classList.add('hidden');
                        document.getElementById('faultInjectionOptions').classList.add('hidden');
                    } else if (taskType === 'FaultInjection') {
                        // 显示故障注入选项
                        document.getElementById('faultInjectionOptions').classList.remove('hidden');
                        // 隐藏其他输入
                        document.getElementById('algorithmSelection').classList.add('hidden');
                        document.getElementById('benchmarkSelection').classList.add('hidden');
                        document.getElementById('datasetSelection').classList.add('hidden');
                        document.getElementById('keyValuePairsContainer').classList.add('hidden');
                    } else {
                        // 显示键值对输入
                        document.getElementById('keyValuePairsContainer').classList.remove('hidden');
                        // 隐藏其他输入
                        document.getElementById('algorithmSelection').classList.add('hidden');
                        document.getElementById('benchmarkSelection').classList.add('hidden');
                        document.getElementById('datasetSelection').classList.add('hidden');
                        document.getElementById('faultInjectionOptions').classList.add('hidden');
                    }
                });

                document.getElementById('faultTypeSelect').addEventListener('change', function() {
                    const selectedFaultTypeKey = this.value;
                    populateFaultParameters(selectedFaultTypeKey);
                });

                // 手动触发一次 change 事件，确保初始状态正确
                taskTypeSelect.dispatchEvent(new Event('change'));
            });
        });
    </script>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-bold mb-4">Task Manager</h1>

        <div class="flex">
            <!-- Task Submission Form -->
            <form id="taskForm" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6 w-full" onsubmit="submitTask(event)">
                <div class="mb-4">
                    <label for="taskType" class="block text-gray-700 text-sm font-bold mb-2">Task Type</label>
                    <select id="taskType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="FaultInjection">Fault Injection</option>
                        <option value="RunAlgorithm">Run Algorithm</option>
                        <option value="EvaluateAlgorithm">Evaluate Algorithm</option>
                    </select>
                </div>

                <!-- 故障注入选项（默认隐藏） -->
                <div id="faultInjectionOptions" class="mb-4 hidden">
                    <label for="faultTypeSelect" class="block text-gray-700 text-sm font-bold mb-2">Fault Type</label>
                    <select id="faultTypeSelect" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- 选项将由 JavaScript 动态填充 -->
                    </select>
                    <div id="faultParameters" class="mt-4">
                        <!-- 参数输入字段将由 JavaScript 动态填充 -->
                    </div>
                </div>

                <!-- Algorithm Selection (hidden by default) -->
                <div id="algorithmSelection" class="mb-4 hidden">
                    <label for="algorithmSelect" class="block text-gray-700 text-sm font-bold mb-2">Algorithm</label>
                    <select id="algorithmSelect" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <!-- Benchmark Selection (hidden by default) -->
                <div id="benchmarkSelection" class="mb-4 hidden">
                    <label for="benchmarkSelect" class="block text-gray-700 text-sm font-bold mb-2">Benchmark</label>
                    <select id="benchmarkSelect" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <!-- Dataset Selection (hidden by default) -->
                <div id="datasetSelection" class="mb-4 hidden">
                    <label for="datasetSelect" class="block text-gray-700 text-sm font-bold mb-2">Dataset</label>
                    <select id="datasetSelect" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <!-- Key-Value Pairs Container -->
                <div id="keyValuePairsContainer" class="mb-4">
                    <label for="keyValuePairs" class="block text-gray-700 text-sm font-bold mb-2">Payload (Key-Value Pairs)</label>
                    <div id="keyValuePairs" class="space-y-2">
                        <div class="flex space-x-4">
                            <input type="text" placeholder="Key" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline key-input">
                            <input type="text" placeholder="Value" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline value-input">
                        </div>
                    </div>
                    <button type="button" class="mt-2 bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-4 rounded focus:outline-none focus:shadow-outline" onclick="addKeyValuePair()">Add Pair</button>
                </div>

                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Submit Task
                    </button>
                </div>
            </form>
        </div>

        <!-- Task List -->
        <h2 class="text-xl font-bold mb-4">Tasks</h2>
        <div class="bg-white shadow-md rounded px-8 pt-6 pb-8">
            {{ if .Tasks }}
                <div class="space-y-4">
                    {{ range .Tasks }}
                        <div class="border-b border-gray-200 pb-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-lg">Task ID: {{ .ID }}</p>
                                    <p class="text-sm text-gray-600">Status: {{ .Status }}</p>
                                </div>
                                <button
                                    id="toggle-btn-{{ .ID }}"
                                    class="bg-blue-500 hover:bg-blue-700 text-white py-1 px-3 rounded focus:outline-none focus:shadow-outline"
                                    onclick="toggleDetails('{{ .ID }}')">
                                    Show Details
                                </button>
                            </div>

                            <!-- Task Details and Logs -->
                            <div id="details-{{ .ID }}" class="hidden bg-gray-100 mt-4 p-4 rounded">
                                <div id="details-{{ .ID }}-content" class="mb-4">
                                    <!-- Task details will be dynamically loaded here -->
                                </div>
                                <div id="logs-{{ .ID }}" class="log-container bg-white border rounded p-2 text-sm text-gray-700">
                                    <!-- Task logs will be dynamically loaded here -->
                                </div>
                            </div>
                        </div>
                    {{ end }}
                </div>
            {{ else }}
                <p class="text-gray-600">No tasks available.</p>
            {{ end }}
        </div>
    </div>

</body>
</html>