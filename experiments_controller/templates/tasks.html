<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <!-- 引入 Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- 引入 Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .log-container {
            max-height: 200px;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        /* 自定义 Select2 的样式以匹配 Tailwind CSS */
        .select2-container .select2-selection--multiple {
            min-height: 2.5rem;
            border-radius: 0.25rem;
            border-color: #d1d5db;
            padding: 0.5rem;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #3b82f6;
            border: none;
            color: white;
            padding: 0 0.5rem;
            margin-top: 0.25rem;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: rgba(255,255,255,0.7);
            margin-right: 0.25rem;
        }
    </style>
    <!-- 引入 jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 引入 Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        async function toggleDetails(taskID) {
            const detailsDiv = document.getElementById(`details-${taskID}`);
            const toggleButton = document.getElementById(`toggle-btn-${taskID}`);

            if (detailsDiv.classList.contains("hidden")) {
                toggleButton.textContent = "Hide Details";
                detailsDiv.classList.remove("hidden");
                await fetchTaskDetails(taskID);
                await fetchTaskLogs(taskID);
            } else {
                toggleButton.textContent = "Show Details";
                detailsDiv.classList.add("hidden");
            }
        }

        async function fetchTaskDetails(taskID) {
            const response = await fetch(`/task/${taskID}/details`);
            const detailsDiv = document.getElementById(`details-${taskID}-content`);
            if (!detailsDiv) return;

            if (response.ok) {
                const data = await response.json();
                detailsDiv.innerHTML = `
                    <p><strong>Task Type:</strong> ${data.type}</p>
                    <p><strong>Payload:</strong> <pre>${JSON.stringify(JSON.parse(data.payload), null, 2)}</pre></p>
                    <p><strong>Status:</strong> ${data.status}</p>
                    <p><strong>Created At:</strong> ${data.created_at}</p>
                `;
            } else {
                detailsDiv.innerHTML = `<p class="text-red-500">Error: Unable to fetch details.</p>`;
            }
        }

        async function fetchTaskLogs(taskID) {
            const response = await fetch(`/task/${taskID}/logs`);
            const logsDiv = document.getElementById(`logs-${taskID}`);
            if (!logsDiv) return;

            if (response.ok) {
                const data = await response.json();
                const parsedLogs = data.logs.map(log => {
                    const splitIndex = log.indexOf(" - ");
                    const time = splitIndex !== -1 ? log.slice(0, splitIndex) : "Unknown";
                    const message = splitIndex !== -1 ? log.slice(splitIndex + 3) : log;
                    return { time, message };
                });
                logsDiv.innerHTML = `
                    <h3 class="font-bold mb-2">Logs:</h3>
                    <ul class="list-disc ml-5">
                        ${parsedLogs
                            .map(log => `<li><strong>${log.time}</strong>: ${log.message}</li>`)
                            .join("")}
                    </ul>
                `;
            } else {
                logsDiv.innerHTML = `<p class="text-red-500">Error: Unable to fetch logs.</p>`;
            }
        }

        function addKeyValuePair() {
            const container = document.getElementById("keyValuePairs");
            const row = document.createElement("div");
            row.className = "flex space-x-4 mb-2";

            row.innerHTML = `
                <input type="text" placeholder="Key" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline key-input">
                <input type="text" placeholder="Value" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline value-input">
                <button type="button" class="text-red-500 font-bold" onclick="this.parentElement.remove()">Remove</button>
            `;

            container.appendChild(row);
        }

        async function submitTask(event) {
            event.preventDefault(); // 阻止表单默认提交

            const taskType = document.getElementById("taskType").value;

            let payload = {};

            if (taskType === "RunAlgorithm") {
                // 从 Select2 获取选中的算法
                const selectedAlgorithms = $('#algorithmSelect').val();
                const benchmark = document.getElementById("benchmarkSelect").value;
                const dataset = document.getElementById("datasetSelect").value;

                if (!selectedAlgorithms || selectedAlgorithms.length === 0) {
                    alert("Please select at least one algorithm.");
                    return;
                }

                // 构建 payload
                payload = {
                    algorithms: selectedAlgorithms,
                    benchmark: benchmark,
                    dataset: dataset
                };

            } else {
                // 从键值对构建 JSON
                const keyInputs = document.querySelectorAll(".key-input");
                const valueInputs = document.querySelectorAll(".value-input");
                payload = {};

                keyInputs.forEach((keyInput, index) => {
                    const key = keyInput.value.trim();
                    const value = valueInputs[index].value.trim();
                    if (key) {
                        payload[key] = value;
                    }
                });

                if (Object.keys(payload).length === 0) {
                    alert("Payload cannot be empty");
                    return;
                }
            }

            const url = `/submit?type=${encodeURIComponent(taskType)}`;
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
            });

            const data = await response.json();
            if (response.ok) {
                alert(`Task submitted successfully: ${data.taskID}`);
                location.reload();
            } else {
                alert(`Error: ${data.error}`);
            }
        }

        async function fetchAlgoBench() {
            try {
                const [algobenchResponse, datasetsResponse] = await Promise.all([
                    fetch('/algobench'),
                    fetch('/datasets')
                ]);

                if (algobenchResponse.ok) {
                    const algobenchData = await algobenchResponse.json();
                    const algorithms = algobenchData.algorithms || [];
                    const benchmarks = algobenchData.benchmarks || [];
                    populateAlgorithmSelect(algorithms);
                    populateBenchmarkSelect(benchmarks);
                } else {
                    console.error('Failed to fetch algorithms and benchmarks');
                }

                if (datasetsResponse.ok) {
                    const datasetsData = await datasetsResponse.json();
                    const datasets = datasetsData.datasets || [];
                    populateDatasetSelect(datasets);
                } else {
                    console.error('Failed to fetch datasets');
                }

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // 使用 Select2 填充算法选择框
        function populateAlgorithmSelect(algorithms) {
            const algorithmSelect = document.getElementById('algorithmSelect');
            algorithmSelect.innerHTML = '';
            algorithms.forEach(algorithm => {
                const option = document.createElement('option');
                option.value = algorithm;
                option.textContent = algorithm;
                algorithmSelect.appendChild(option);
            });
            // 初始化 Select2
            $('#algorithmSelect').select2({
                placeholder: 'Select Algorithms',
                allowClear: true,
                width: '100%'
            });
        }

        function populateBenchmarkSelect(benchmarks) {
            const benchmarkSelect = document.getElementById('benchmarkSelect');
            benchmarkSelect.innerHTML = '';
            benchmarks.forEach(benchmark => {
                const option = document.createElement('option');
                option.value = benchmark;
                option.textContent = benchmark;
                benchmarkSelect.appendChild(option);
            });
        }

        function populateDatasetSelect(datasets) {
            const datasetSelect = document.getElementById('datasetSelect');
            datasetSelect.innerHTML = '';
            datasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset;
                option.textContent = dataset;
                datasetSelect.appendChild(option);
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            fetchAlgoBench();

            document.getElementById('taskType').addEventListener('change', function() {
                const taskType = this.value;
                if (taskType === 'RunAlgorithm') {
                    // 显示算法、基准和数据集选择
                    document.getElementById('algorithmSelection').classList.remove('hidden');
                    document.getElementById('benchmarkSelection').classList.remove('hidden');
                    document.getElementById('datasetSelection').classList.remove('hidden');
                    // 隐藏键值对输入
                    document.getElementById('keyValuePairsContainer').classList.add('hidden');
                } else {
                    // 隐藏算法、基准和数据集选择
                    document.getElementById('algorithmSelection').classList.add('hidden');
                    document.getElementById('benchmarkSelection').classList.add('hidden');
                    document.getElementById('datasetSelection').classList.add('hidden');
                    // 显示键值对输入
                    document.getElementById('keyValuePairsContainer').classList.remove('hidden');
                }
            });
        });
    </script>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-bold mb-4">Task Manager</h1>

        <div class="flex">
            <!-- Task Submission Form -->
            <form id="taskForm" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-6 w-full" onsubmit="submitTask(event)">
                <div class="mb-4">
                    <label for="taskType" class="block text-gray-700 text-sm font-bold mb-2">Task Type</label>
                    <select id="taskType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="FaultInjection">Fault Injection</option>
                        <option value="RunAlgorithm">Run Algorithm</option>
                        <option value="EvaluateAlgorithm">Evaluate Algorithm</option>
                    </select>
                </div>

                <!-- Algorithm Selection (hidden by default) -->
                <div id="algorithmSelection" class="mb-4 hidden">
                    <label for="algorithmSelect" class="block text-gray-700 text-sm font-bold mb-2">Algorithm</label>
                    <select id="algorithmSelect" multiple class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <!-- Benchmark Selection (hidden by default) -->
                <div id="benchmarkSelection" class="mb-4 hidden">
                    <label for="benchmarkSelect" class="block text-gray-700 text-sm font-bold mb-2">Benchmark</label>
                    <select id="benchmarkSelect" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <!-- Dataset Selection (hidden by default) -->
                <div id="datasetSelection" class="mb-4 hidden">
                    <label for="datasetSelect" class="block text-gray-700 text-sm font-bold mb-2">Dataset</label>
                    <select id="datasetSelect" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <!-- Key-Value Pairs Container -->
                <div id="keyValuePairsContainer" class="mb-4">
                    <label for="keyValuePairs" class="block text-gray-700 text-sm font-bold mb-2">Payload (Key-Value Pairs)</label>
                    <div id="keyValuePairs" class="space-y-2">
                        <div class="flex space-x-4">
                            <input type="text" placeholder="Key" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline key-input">
                            <input type="text" placeholder="Value" class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline value-input">
                        </div>
                    </div>
                    <button type="button" class="mt-2 bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-4 rounded focus:outline-none focus:shadow-outline" onclick="addKeyValuePair()">Add Pair</button>
                </div>

                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Submit Task
                    </button>
                </div>
            </form>
        </div>

        <!-- Task List -->
        <h2 class="text-xl font-bold mb-4">Tasks</h2>
        <div class="bg-white shadow-md rounded px-8 pt-6 pb-8">
            {{ if .Tasks }}
                <div class="space-y-4">
                    {{ range .Tasks }}
                        <div class="border-b border-gray-200 pb-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-lg">Task ID: {{ .ID }}</p>
                                    <p class="text-sm text-gray-600">Status: {{ .Status }}</p>
                                </div>
                                <button
                                    id="toggle-btn-{{ .ID }}"
                                    class="bg-blue-500 hover:bg-blue-700 text-white py-1 px-3 rounded focus:outline-none focus:shadow-outline"
                                    onclick="toggleDetails('{{ .ID }}')">
                                    Show Details
                                </button>
                            </div>

                            <!-- Task Details and Logs -->
                            <div id="details-{{ .ID }}" class="hidden bg-gray-100 mt-4 p-4 rounded">
                                <div id="details-{{ .ID }}-content" class="mb-4">
                                    <!-- Task details will be dynamically loaded here -->
                                </div>
                                <div id="logs-{{ .ID }}" class="log-container bg-white border rounded p-2 text-sm text-gray-700">
                                    <!-- Task logs will be dynamically loaded here -->
                                </div>
                            </div>
                        </div>
                    {{ end }}
                </div>
            {{ else }}
                <p class="text-gray-600">No tasks available.</p>
            {{ end }}
        </div>
    </div>

</body>
</html>