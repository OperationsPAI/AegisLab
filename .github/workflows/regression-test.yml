name: Remote Regression Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci 

      - name: Verify Tailscale Connection
        run: |
          echo "Testing DNS resolution:"
          for i in {1..5}; do
            ping -c 1 ${{ vars.TEST_SERVER_HOST }} && break || sleep 2
          done

      - name: Run Regression Tests via SSH
        run: |
          set -e
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o LogLevel=ERROR \
              ${{ vars.TEST_SERVER_USER }}@${{ vars.TEST_SERVER_HOST }} \
              "cd ~/workspace/AegisLab && \
               git fetch origin && \
               git reset --hard origin/main && \
               echo '--- Starting Regression Test #${{ github.run_number }} ---' && \
               mkdir -p logs/test && \
               LOG_FILE=logs/test/remote_test_${{ github.run_number }}.txt && \
               devbox run -- make regression-test > \$LOG_FILE 2>&1 || (cat \$LOG_FILE && exit 1) && \
               cat \$LOG_FILE"

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up Tailscale connection"