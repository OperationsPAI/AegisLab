name: Publish Python SDK

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      tag_version:
        description: "Version tag to simulate (e.g. v1.2.3)"
        required: true
        default: "v0.0.0"

permissions:
  actions: read
  contents: read
  packages: write
  id-token: write

jobs:
  pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    environment:
      name: pypi

    env:
      BLUE: "\033[1;34m"
      GREEN: "\033[1;32m"
      YELLOW: "\033[1;33m"
      RED: "\033[1;31m"
      CYAN: "\033[1;36m"
      GRAY: "\033[1;90m"
      RESET: "\033[0m"

      SDK_DIR: "sdk/python"
      SDK_OPENAPI_DIR: "sdk/python/src/rcabench/openapi"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Command Tool
        id: prepare_command_tool
        uses: ./.github/actions/prepare-command-tool
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: extract_version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            RAW_VERSION="${{ github.ref }}"
          else
            RAW_VERSION="${{ github.event.inputs.tag_version }}"
          fi

          VERSION=${RAW_VERSION#refs/tags/v}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          printf "${GREEN}üì¶ Extracted Version: $VERSION${RESET}\n"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          printf "${BLUE}üì• Installing Ruff...${RESET}\n"
          curl -LsSf https://astral.sh/ruff/install.sh | sh
          printf "${GREEN}‚úÖ Ruff installed${RESET}\n"

          printf "${BLUE}üì• Installing Go dependencies...${RESET}\n"
          go install github.com/swaggo/swag/cmd/swag@latest
          (
            cd src && go mod tidy
          )
          printf "${GREEN}‚úÖ Dependencies installed${RESET}\n"

      - name: Generate Python SDK
        run: |
          printf "${BLUE}üîß Starting SDK generation via Makefile...${RESET}\n"

          env_mode="prod"
          if [ "${{ steps.prepare_command_tool.outputs.binary_exists }}" != "true" ]; then
            printf "${YELLOW}‚ö†Ô∏è Command tool binary not found, using local build fallback${RESET}\n"
            env_mode="dev"
          fi

          make generate-python-sdk ENV_MODE=${env_mode} SDK_VERSION=${{ steps.extract_version.outputs.version }}

      - name: Verify SDK Generation
        run: |
          printf "${BLUE}üîç Verifying generated SDK...${RESET}\n"

          if [ ! -d "${SDK_OPENAPI_DIR}" ]; then
            printf "${RED}‚ùå SDK openapi directory not found${RESET}\n"
            exit 1
          fi

          if [ ! -f "${SDK_DIR}/pyproject.toml" ]; then
            printf "${RED}‚ùå pyproject.toml not found${RESET}\n"
            exit 1
          fi

          printf "${GREEN}‚úÖ SDK structure verified${RESET}\n"
          printf "${GRAY}SDK contents:${RESET}\n"
          ls -lh ${SDK_OPENAPI_DIR}

      - name: Build and publish
        run: |
          cd ${SDK_DIR}
          printf "${BLUE}üî® Building SDK package...${RESET}\n"
          uv build

          printf "${BLUE}üì¶ Publishing to PyPI...${RESET}\n"
          uv publish --trusted-publishing always

          printf "${GREEN}‚úÖ Successfully published to PyPI!${RESET}\n"
