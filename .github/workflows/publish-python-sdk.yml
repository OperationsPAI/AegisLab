name: Publish Python SDK

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      tag_version:
        description: "Version tag to simulate (e.g. v1.2.3)"
        required: true
        default: "0.0.0-manual-test"

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    environment:
      name: pypi

    env:
      BLUE: "\033[1;34m"
      GREEN: "\033[1;32m"
      YELLOW: "\033[1;33m"
      RED: "\033[1;31m"
      CYAN: "\033[1;36m"
      GRAY: "\033[1;90m"
      RESET: "\033[0m"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find Latest Formatter Build Run ID
        id: find_run
        run: |
          set -e 

          # Check for in_progress runs
          IN_PROGRESS=$(gh api \
            --header 'Accept: application/vnd.github.v3+json' \
            /repos/${{ github.repository }}/actions/workflows/build-make-command.yaml/runs \
            -f status=in_progress \
            --jq '.workflow_runs | length')

          # Check for queued runs
          QUEUED=$(gh api \
            --header 'Accept: application/vnd.github.v3+json' \
            /repos/${{ github.repository }}/actions/workflows/build-make-command.yaml/runs \
            -f status=queued \
            --jq '.workflow_runs | length')

          ACTIVE_RUNS=$((IN_PROGRESS + QUEUED))

          if [[ "$ACTIVE_RUNS" -gt 0 ]]; then
              printf "${YELLOW}‚ö†Ô∏è WARNING: Found $ACTIVE_RUNS active build-make-command runs. Proceeding with the latest successful artifact instead of waiting.${RESET}\n"
          fi

          RUN_ID=$(gh api \
            --header 'Accept: application/vnd.github.v3+json' \
            /repos/${{ github.repository }}/actions/workflows/build-make-command.yaml/runs \
            -f status=success \
            --jq '.workflow_runs[0].id')

          if [[ "$RUN_ID" == "null" || -z "$RUN_ID" ]]; then
              printf "${YELLOW}‚ö†Ô∏è WARNING: No successful build-make-command run found. Cannot guarantee latest artifact freshness.${RESET}\n"
              echo "run_id=''" >> $GITHUB_OUTPUT
          else
              printf "${GREEN}‚úÖ Found latest successful build run ID: $RUN_ID${RESET}\n"
              echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Make command tool artifact
        uses: actions/download-artifact@v4
        if: success() && steps.find_run.outputs.run_id
        with:
          name: make-command-tool
          path: scripts/command
          run-id: ${{ steps.find_run.outputs.run_id }}

      - name: Set Binary Permissions
        if: success() && steps.find_run.outputs.run_id
        run: |
          chmod +x scripts/command/command.bin
          printf "${GREEN}‚úÖ Binary permissions set${RESET}\n"
          ls -lh scripts/command/command.bin

      - name: Fallback - Build command tool if artifact not found
        if: success() && steps.find_run.outputs.run_id == ''
        run: |
          printf "${YELLOW}‚ö†Ô∏è No artifact found, building command tool locally...${RESET}\n"
          make build-make-command

      - name: Extract version from tag
        id: extract_version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            RAW_VERSION="${{ github.ref }}"
          else
            RAW_VERSION="${{ github.event.inputs.tag_version }}"
          fi

          VERSION=${RAW_VERSION#refs/tags/v}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted Version: $VERSION"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          # Install swag for generating Swagger documentation
          go install github.com/swaggo/swag/cmd/swag@latest
          cd src && go mod tidy

      - name: Generate Python SDK
        run: |
          printf "${BLUE}Starting SDK generation via Makefile...${RESET}\n"
          make generate-python-sdk SDK_VERSION=${{ steps.extract_version.outputs.version }}

      - name: Verify SDK Generation
        run: |
          printf "${BLUE}üîç Verifying generated SDK...${RESET}\n"

          if [ ! -d "sdk/python" ]; then
            printf "${RED}‚ùå SDK directory not found${RESET}\n"
            exit 1
          fi

          if [ ! -f "sdk/python/pyproject.toml" ]; then
            printf "${RED}‚ùå pyproject.toml not found${RESET}\n"
            exit 1
          fi

          printf "${GREEN}‚úÖ SDK structure verified${RESET}\n"

      - name: Build and publish
        run: |
          cd sdk/python
          printf "${BLUE}üî® Building SDK...${RESET}\n"
          uv build

          printf "${BLUE}üì¶ Publishing to PyPI...${RESET}\n"
          uv publish --trusted-publishing always

          printf "${GREEN}‚úÖ Successfully published to PyPI!${RESET}\n"
